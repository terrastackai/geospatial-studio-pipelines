
RUN pip install terratorch[vllm]

WORKDIR /app

ENV HF_HOME=/app/models/huggingface_cache
ENV TERRATORCH_SEGMENTATION_IO_PROCESSOR_CONFIG='{"output_path": "/data/outputs/"}'

COPY ./vllm_startup.sh /app/start_vllm.sh

USER root

RUN mkdir -p /app/models/huggingface_cache/hub /data/outputs

ENV UID=10001 \
    USER=appuser

# hadolint ignore=SC2086
RUN groupadd -g ${UID} -r ${USER} \
    && useradd -l -u ${UID} -r -g ${USER} ${USER} -ms /bin/bash \
    && mkdir -p /home/${USER}/.local \
    && mkdir -p /home/${USER}/.cache \
    && chown -R ${UID}:${UID} /home/${USER} /app \
    && chmod -R 777 /app /data \
    && chmod +x /app/start_vllm.sh

USER ${USER}

EXPOSE 8000

HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

ENTRYPOINT ["/bin/bash", "/app/start_vllm.sh"]
